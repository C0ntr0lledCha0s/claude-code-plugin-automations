name: Validate Plugins

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Validate all plugins
        id: validate
        run: |
          echo "ğŸ” Running comprehensive plugin validation..."
          bash validate-all.sh
        continue-on-error: true

      - name: Check for security issues
        id: security
        run: |
          echo "ğŸ” Checking for security issues..."
          ERRORS=0

          # Check for hardcoded paths (should use ${PLUGIN_DIR})
          if grep -r "github-workflows/hooks" --include="hooks.json" .; then
            echo "âŒ Found hardcoded plugin paths in hooks"
            ERRORS=$((ERRORS + 1))
          fi

          # Check for secrets in code
          if grep -riE "(password|secret|api[_-]?key|token)\s*=\s*['\"][^'\"]+['\"]" \
            --include="*.sh" --include="*.py" --include="*.md" \
            --exclude-dir=".git" --exclude-dir="node_modules" .; then
            echo "âš ï¸  Warning: Potential secrets found in code"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "âŒ Security checks failed with $ERRORS error(s)"
            exit 1
          fi
          echo "âœ“ Security checks passed"
        continue-on-error: true

      - name: Check validation results
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Validation Results Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          FAILED=0

          if [ "${{ steps.validate.outcome }}" == "failure" ]; then
            echo "âŒ Plugin validation: FAILED"
            FAILED=1
          else
            echo "âœ… Plugin validation: PASSED"
          fi

          if [ "${{ steps.security.outcome }}" == "failure" ]; then
            echo "âŒ Security checks: FAILED"
            FAILED=1
          else
            echo "âœ… Security checks: PASSED"
          fi

          echo ""

          if [ $FAILED -gt 0 ]; then
            echo "âŒ Overall validation FAILED - see logs above for details"
            exit 1
          else
            echo "âœ… All validations passed!"
          fi

      - name: Comment on PR with validation results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âŒ Validation Failed

            The plugin validation checks failed. Please fix the errors and push your changes.

            ### How to Fix

            1. **Run validation locally**:
               \`\`\`bash
               bash validate-all.sh
               \`\`\`

            2. **Check the error messages** in the [workflow run logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

            3. **Common issues**:
               - Commands using short model aliases (\`model: sonnet\`) - only agents can use short aliases
               - Invalid YAML frontmatter
               - Missing required fields
               - Naming convention violations

            4. **Use agent-builder tools** when modifying components:
               - Invoke \`building-commands\` skill for command changes
               - Invoke \`building-agents\` skill for agent changes
               - Run validation scripts before committing

            ### Need Help?

            - Check validation error messages for fix suggestions
            - See [CLAUDE.md](${context.payload.repository.html_url}/blob/main/CLAUDE.md) for development guidelines
            - Review templates in \`agent-builder/skills/*/templates/\`

            Once you've fixed the issues, push your changes and validation will run again automatically.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
